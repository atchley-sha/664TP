# Traffic and Improvement Analysis

{{< include ../setup.qmd >}}


```{r}
rt <- 2
max_val <- 5
min_val <- -max_val
color_scale <- scales::gradient_n_pal(c("blue", "white", "red"), values = c(-abs(min_val)^(1/rt), 0, max_val^(1/rt)))

delay_and_los_table_viz <- function(tbl, comparison = NULL){
  
  if(!is.null(comparison)){
    full_tbl <- tbl %>% 
      left_join(comparison %>% select(-c(l_los:i_los)), by = c("intersection", "direction"), suffix = c("", "_old")) %>% 
      mutate(across(contains("delay"), \(x) as.numeric(x))) %>% 
      transmute(
        diff_l = l_delay - l_delay_old,
        diff_t = t_delay - t_delay_old,
        diff_r = r_delay - r_delay_old,
        diff_i = i_delay - i_delay_old,
        # diff = pick(l_delay:i_delay) - pick(l_delay_old:i_delay_old),
        intersection, direction) %>% 
      mutate(across(contains("diff"), \(x) replace_na(x, 0)),
             across(contains("diff"), \(x) case_when(
               x < 0 ~ -abs(pmax(x, min_val))^(1/rt),
               x >= 0 ~ pmin(x, max_val)^(1/rt)
             ))) %>% 
      left_join(tbl, by = c("intersection", "direction"))
  } else {
    full_tbl <- tbl
  }
  
  
  viz <- full_tbl %>%
    flextable(
      col_keys = colnames(full_tbl)[!str_detect(colnames(full_tbl), "diff")]
      ) %>% 
    set_header_labels(
      intersection = "Intersection",
      direction = "Direction",
      l_delay = "Left",
      t_delay = "Thru",
      r_delay = "Right",
      i_delay = "Intersection",
      l_los = "Left",
      t_los = "Thru",
      r_los = "Right",
      i_los = "Intersection"
    ) %>%
    add_header_row(values = c("Intersection", "Direction", "Average Control Delay (sec)", "Level of Service"), colwidths = c(1,1,4,4)) %>%
    align(align = "c", part = "a") %>%
    merge_v(j = ~ intersection, target = ~intersection + i_delay + i_los) %>%
    merge_v(~ intersection + direction, part = "h") %>%
    fix_border_issues() %>%
    theme_box() %>%
    align(align = "c", part = "a") %>%
    valign(part = "a") %>%
    autofit() %>%
    fit_to_width(6)
  
  if(!is.null(comparison)){
    viz %>% 
      bg(j = ~l_delay + t_delay + r_delay + i_delay, bg = color_scale, source = ~diff_l + diff_t + diff_r + diff_i) %>% 
      bg(j = ~l_los + t_los + r_los + i_los, bg = color_scale, source = ~diff_l + diff_t + diff_r + diff_i)
  } else {
    viz
  }
}

# get_delay_difference <- function(new, old, max_val = 5){
#   new_delay <- new %>% 
#     filter(intersection %in% old$intersection) %>% 
#     select(l_delay:i_delay) %>% 
#     mutate(across(everything(), as.numeric))
#   old_delay <- old %>% 
#     select(l_delay:i_delay) %>% 
#     mutate(across(everything(), as.numeric))
#   
#   new_rows <- nrow(new) - nrow(old)
#   
#     color_scale <- scales::gradient_n_pal(c("blue", "white", "red"), values = c(-max_val, 0, max_val))
#   
#   diff <- (new_delay - old_delay) %>% 
#     mutate(across(everything(), \(x) replace_na(x, 0)))
#   
#   color_diff <- diff %>% 
#     mutate(across(everything(), \(x) case_when(
#       x < 0 ~ pmax(x, -max_val),
#       x >= 0 ~ pmin(x, max_val)
#     )),
#     across(everything(), \(x) color_scale(x))) %>% 
#     add_ro
#   
#   all_colors <- cbind(
#     color_diff,
#     color_diff %>%
#       `colnames<-`(str_replace(
#         colnames(color_diff), "delay", "los"))) %>% 
#     mutate(intersection = "#FFFFFF", direction = "#FFFFFF", .before = 1)
#   
#   # all_colors
#   color_diff
# }
```


This section analyzes the impact of {{< var devname >}} on the roadways and intersections in the study area. A \acr{LOS} analysis is performed for both opening day (2024) and the 5-year horizon (2029). The analysis is done for both the no-build and build scenarios at each horizon year.

## Level of Service

Based on the traffic assignment as determined in @sec-trip-assignment, a \acr{LOS} analysis was performed to determine the average delay per vehicle, and assign a \acr{LOS} designation (see  @tbl-los-intersections). Both the no-build and build scenarios are analyzed, and these results are presented in Tables [-@tbl-los-yrop-nobuild]--[-@tbl-los-yr5-build]. The direct analysis reports are also provided in @sec-apdx-synchro-future. In the build scenarios, the tables are colored according to the effect of site traffic on the delay value: bright blue indicates a decrease in delay of `r -min_val` or more seconds, and bright red indicates an increase in delay of `r max_val` or more seconds, with a color gradient for effects in-between.

Note that because of limitations in the Synchro software used for this analysis [@trafficware2019], the U-turn movements at the University Ave./1200 South intersection could not be analyzed, so these were added to the left-turn movement.

```{r}
#| label: tbl-los-yrop-nobuild
#| tbl-cap: Opening Year (2024) LOS Analysis, No-Build scenario
#| warning: false

tar_read(los_table_yrop_nobuild) %>% 
  delay_and_los_table_viz() %>% 
  fit_to_width(6)
```

```{r}
#| label: tbl-los-yrop-build
#| tbl-cap: Opening Year (2024) LOS Analysis, Build Scenario
#| warning: false

tar_read(los_table_yrop_build) %>% 
  delay_and_los_table_viz(tar_read(los_table_yrop_nobuild)) %>% 
  fit_to_width(6)
```

```{r}
#| label: tbl-los-yr5-nobuild
#| tbl-cap: 5-Year (2029) LOS Analysis, No-Build Scenario
#| warning: false

tar_read(los_table_yr5_nobuild) %>% 
  delay_and_los_table_viz() %>% 
  fit_to_width(6)
```

```{r}
#| label: tbl-los-yr5-build
#| tbl-cap: 5-Year (2029) LOS Analysis, Build Scenario
#| warning: false

tar_read(los_table_yr5_build) %>% 
  delay_and_los_table_viz(tar_read(los_table_yr5_nobuild)) %>% 
  fit_to_width(6)
```

Based on these results, the {{< var devname >}} development has virtually no impact on the delay/\acr{LOS} of the intersections at either the opening day or 5-year horizons. While some movements perform worse with the site trips added, many perform better, and in any case the difference in delay is minimal. However, this analysis *does* show movements that perform poorly, but these do so even with the background traffic alone, and in fact the delay does not substantially increase between the opening day and 5-year background traffic.

## Roadway/Intersection Improvements

Though the development of {{< var devname >}} is expected to have virtually no
impact on the delay/\acr{LOS} of the study area, Tables
[-@tbl-los-yrop-nobuild]--[-@tbl-los-yr5-build] show that especially left turns
on University Ave. tend to perform poorly in the study area. An important note however is that \acr{LOS} measures *average* delay, and so movement volumes can significantly affect these results. For example, the University Ave./1200 South \acr{SB} direction has much better \acr{LOS} than the \acr{EB} movement, but also an order of magnitude more volume. The *total* delay is therefore much more comparable between the two directions (and in fact the total \acr{SB} delay is worse than the \acr{EB} delay despite having a better \acr{LOS}). Whether these poorly-performing movements present a problem at all then is a point of discussion. An \acr{LOS} of 'D' or better is usually considered acceptible, and these movements do not reach that goal, but this may be acceptible anyway due to their quite low volumes. If improvements are determined to be necessary, there are various potential options that could be effective:

It is possible that a change in signal timings alone would increase performance. The
through movements on University Ave. perform quite well, with \acr{LOS} 'A' or
'B'. Increasing the length of the left-turn phase(s) in the University Ave.
intersections would provide a more consistent \acr{LOS} across movements.
However, this analysis only looks at the study area, and does not account for
the rest of the University Ave. corridor. It is possible that changing the
signal timings here may cause greater problems at downstream/upstream
intersections, and so a full analysis of the corridor should be done before
implementing any changes.

Another possibility would be to remove or otherwise prohibit use of certain accesses on University Ave. from other developments. Several driveways are e.g. located directly adjacent to the University Ave./Towne Centre Dr. intersection (see @fig-uatcd-bad-access). These present many conflict points between vehicles using the intersection and vehicles using the driveway, especially for left-turning vehicles. A raised median or similar improvement would prevent many of these conflict points. It is not clear however that these driveways affect the delay at these intersections, so this solution may not be effective.

```{r}
#| label: fig-uatcd-bad-access
#| fig.cap: Driveways located immediately adjacent to the University Ave./Towne Centre Dr. intersection.
#| out.width: 6in

knitr::include_graphics("../images/reference/bad_access_uatcb.png")
```

If the above solutions do not mitigate the problem, it may be necessary to decrease traffic volumes on University Ave. by providing other convenient routes or modes. Many of the failing movements already have dual left-turn lanes, and University Ave. itself has 3 through lanes in each direction, so increasing the number of lanes would be infeasible and ineffective. It is possible that a speed limit increase would improve intersection performance, but this would present safety concerns due to the increased speed differential at the driveways as well as the presence of a \acr{TWLTL} on University Ave. A raised median could fix the latter, but not the former. Additionally, it is worth noting that adding a raised median to University Ave. would increase safety regardless, and is recommended, but this is outside the scope of this project.

While some of these solutions may improve performance, again it is important to note the scope of the effect. The performance improvements would be for a relatively small number of vehicles, and could decrease performance for a larger traffic volume. Additionally, the majority of the reasonable improvements to this section of University Ave. have already been made (with a raised median being the main exception), and so physical changes to the roadway or intersections would be expensive and complicated, with little impact on facility performance. Because of the small volumes affected by the poor \acr{LOS} movements, roadway improvemnts other than potential signal timing changes would not be worth the investment.
